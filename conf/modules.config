/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

process {
    /*
    ================================================================================
                            All modules
    ================================================================================
    */
    publishDir = [
        [
            // Stdout and stderr
            path:    params.process_log_dir,
            mode:    params.publish_dir_mode,
            pattern: ".command.*",
            saveAs:  { filename -> "${meta.id}.${task.process}${filename}" }
        ],
        [
            // QC file checks
            path:    params.qc_filecheck_log_dir,
            mode:    params.publish_dir_mode,
            pattern: "*.*{File,Files}.tsv"
        ]
    ]

    /*
    ================================================================================
                            Module specific
    ================================================================================
    */

    /*
     * Local modules
     */
    withName: ANNOTATE_PROKKA {
        publishDir = [
            path:    { "${params.outdir}/Prokka" },
            mode:    params.publish_dir_mode,
            pattern: "*.gbk"
        ]
    }

    withName: ASSEMBLE_CONTIGS_SKESA {
        publishDir = [
            path:    { "${params.outdir}/Assembly/SKESA/${meta.id}/" },
            mode:    params.publish_dir_mode,
            pattern: "contigs.fasta"
        ]
    }

    withName: ASSEMBLE_CONTIGS_SPADES {
        publishDir = [
            path:    { "${params.outdir}/Assembly/SPAdes/" },
            mode:    params.publish_dir_mode,
            pattern: { "${meta.id}/" }
        ]
    }

    withName: BEST_16S_BLASTN_BITSCORE_TAXON_PYTHON {
        publishDir = [
            path:    { "${params.outdir}/SSU/BLAST/" },
            mode:    params.publish_dir_mode,
            pattern: "*.blast.tsv.gz"
        ]
    }

    withName: EXTRACT_16S_BARRNAP {
        publishDir = [
            path:    { "${params.outdir}/SSU/" },
            mode:    params.publish_dir_mode,
            pattern: "16S.*.fa"
        ]
    }

    withName: MAP_CONTIGS_BWA {
        publishDir = [
            path:    { "${params.outdir}/Assembly/" },
            mode:    params.publish_dir_mode,
            pattern: "*.fna"
        ]
    }

    withName: OVERLAP_PAIRED_READS_FLASH {
        publishDir = [
            path:    { "${params.outdir}/ReadTrimming/FLASH/" },
            mode:    params.publish_dir_mode,
            pattern: "*.{overlap.tsv,clean-reads.tsv,fq.gz}"
        ]
    }

    withName: POLISH_ASSEMBLY_BWA_PILON {
        publishDir = [
            [
                path:    { "${params.outdir}/Assembly/" },
                mode:    params.publish_dir_mode,
                pattern: "*.fna"
            ],
            [
                path:    { "${params.outdir}/Assembly/${assembler}/${meta.id}/" },
                mode:    params.publish_dir_mode,
                pattern: "*.{InDels,SNPs}-corrected.cnt.txt"
            ]
        ]
    }

    withName: READ_CLASSIFY_KRAKEN_ONE {
        publishDir = [
            [
                path:    { "${params.outdir}/Taxonomy/kraken/${meta.id}/" },
                mode:    params.publish_dir_mode,
                pattern: "*_kraken1.tab.gz"
            ],
            [
                path:    { "${params.outdir}/Taxonomy/kraken/${meta.id}/" },
                mode:    params.publish_dir_mode,
                pattern: "*.taxonomy1-reads.tab"
            ]
        ]
    }

    withName: READ_CLASSIFY_KRAKEN_TWO {
        publishDir =[
            [
                path:    { "${params.outdir}/Taxonomy/kraken2/${meta.id}/" },
                mode:    params.publish_dir_mode,
                pattern: "*_kraken2.tab.gz"
            ],
            [
                path:    { "${params.outdir}/Taxonomy/kraken2/${meta.id}/" },
                mode:    params.publish_dir_mode,
                pattern: "*.taxonomy2-reads.tab"
            ]
        ]
    }

    withName: TRIM_READS_TRIMMOMATIC {
        publishDir = [
            path:    { "${params.outdir}/trim_reads" },
            mode:    params.publish_dir_mode,
            pattern: "*.trimmo.tsv"
        ]
    }

    /*
     * nf-core modules
     */
    withName: QA_ASSEMBLY_GTDBTK {
        publishDir = [
            path:    { "${params.outdir}/qa" },
            mode:    params.publish_dir_mode,
            pattern: "*.summary.tsv",
            saveAs:  { filename -> "Summary.GTDBTk.tab" }
        ]

    }

    withName: QA_ASSEMBLY_BUSCO {
        ext.args = "-m genome"
        publishDir = [
            path:    { "${params.outdir}/qa" },
            mode:    params.publish_dir_mode,
            pattern: "*.batch_summary.txt",
            saveAs:  { filename -> "Summary.BUSCO.tab" }
        ]
    }
}

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    MODULES.CONFIG FUNCTIONS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

// Convert params.assembler to lowercase
def toLower(it) {
    it.toString().toLowerCase()
}

params.assembler = toLower(params.assembler)

if (params.assembler == "skesa") {
    assembler = "SKESA"
} else {
    assembler = "SPAdes"
}
